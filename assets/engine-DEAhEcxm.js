var O=Object.defineProperty;var _=(o,t,i)=>t in o?O(o,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):o[t]=i;var f=(o,t,i)=>_(o,typeof t!="symbol"?t+"":t,i);const b={player:"#3b82f6",gem:"#10b981",damageText:"#f87171",background:"#0f0f11",shadowBolt:"#818cf8",obsidianShard:"#475569",spectralShield:"#67e8f9",corrosiveAura:"#84cc16",thunderStrike:"#e879f9",plasmaCutter:"#fb923c",bloodSiphon:"#dc2626",umbralBarrage:"#4c1d95",frostNova:"#22d3ee",whirlingAxe:"#a16207",flameBreath:"#f97316",voidTrap:"#581c87",ricochetBlade:"#94a3b8",vortexOrb:"#7c3aed",infernoGrenade:"#b91c1c",phantomDaggers:"#e2e8f0",destructible:"#b45309",gold:"#fbbf24"},D={spinach:{name:"Dark Arts",description:"Increases Might by 10%.",maxLevel:5,stat:"might",increase:.1,icon:"skull"},empty_tome:{name:"Chrono Shard",description:"Reduces Cooldowns by 8%.",maxLevel:5,stat:"cooldownReduction",increase:.08,icon:"clock"},candelabrador:{name:"Void Expander",description:"Increases Area by 10%.",maxLevel:5,stat:"area",increase:.1,icon:"maximize"},bracer:{name:"Wind Gauntlet",description:"Increases Projectile Speed by 10%.",maxLevel:5,stat:"speed",increase:.1,icon:"wind"},clover:{name:"Fortune Die",description:"Increases Luck by 10%. Critical hits deal 2x damage.",maxLevel:5,stat:"luck",increase:.1,icon:"clover"},wings:{name:"Swift Boots",description:"Increases Move Speed by 10%.",maxLevel:5,stat:"moveSpeed",increase:.1,icon:"footprints"},attractorb:{name:"Magnetic Amulet",description:"Increases Pickup Range by 25%.",maxLevel:5,stat:"magnet",increase:.25,icon:"magnet"},pummarola:{name:"Regen Heart",description:"Recover 0.2 HP/s.",maxLevel:5,stat:"recovery",increase:.2,icon:"heart"},duplicator:{name:"Mirror Echo",description:"Increases Projectile Amount by 1.",maxLevel:2,stat:"amount",increase:1,icon:"copy"}},B=[{id:"might",name:"Might",description:"Increases damage dealt by 5%.",icon:"âš”ï¸",baseCost:200,costMultiplier:1.5,maxLevel:5,statKey:"might",valuePerLevel:.05},{id:"armor",name:"Vitality",description:"Increases Max HP by 10%.",icon:"â¤ï¸",baseCost:150,costMultiplier:1.3,maxLevel:5,statKey:"maxHp",valuePerLevel:.1},{id:"recovery",name:"Recovery",description:"Recover 0.2 HP per second.",icon:"ðŸ’–",baseCost:300,costMultiplier:1.7,maxLevel:5,statKey:"recovery",valuePerLevel:.2},{id:"cooldown",name:"Haste",description:"Reduces cooldowns by 2.5%.",icon:"âš¡",baseCost:400,costMultiplier:1.8,maxLevel:5,statKey:"cooldownReduction",valuePerLevel:.025},{id:"area",name:"Area",description:"Increases attack area by 5%.",icon:"ðŸ’¥",baseCost:300,costMultiplier:1.5,maxLevel:5,statKey:"area",valuePerLevel:.05},{id:"speed",name:"Speed",description:"Increases projectile speed by 5%.",icon:"ðŸ¹",baseCost:200,costMultiplier:1.4,maxLevel:3,statKey:"speed",valuePerLevel:.05},{id:"growth",name:"Growth",description:"Increases XP gain by 5%.",icon:"ðŸŒ±",baseCost:500,costMultiplier:2,maxLevel:5,statKey:"growth",valuePerLevel:.05},{id:"greed",name:"Greed",description:"Increases Gold gain by 10%.",icon:"ðŸ’°",baseCost:400,costMultiplier:1.8,maxLevel:5,statKey:"greed",valuePerLevel:.1},{id:"luck",name:"Luck",description:"Increases Crit Chance by 5%.",icon:"ðŸ€",baseCost:600,costMultiplier:2,maxLevel:3,statKey:"luck",valuePerLevel:.05},{id:"magnet",name:"Magnet",description:"Increases pickup range by 15%.",icon:"ðŸ§²",baseCost:250,costMultiplier:1.4,maxLevel:3,statKey:"magnet",valuePerLevel:.15}],L={BAT:{hp:10,speed:2,damage:5,xp:1,radius:10,color:"#ef4444"},ZOMBIE:{hp:25,speed:1.2,damage:10,xp:3,radius:14,color:"#22c55e"},SKELETON:{hp:50,speed:1.5,damage:15,xp:5,radius:14,color:"#cbd5e1"},GHOST:{hp:15,speed:2.8,damage:8,xp:2,radius:12,color:"#94a3b8"},BOSS:{hp:3e3,speed:2.5,damage:40,xp:1e3,radius:45,color:"#a855f7"}},A=[{id:"kael",name:"Kael",title:"The Riftwalker",description:"Balanced stats. Starts with Shadow Bolt.",unlockCondition:"Unlocked by default.",isUnlocked:()=>!0,baseStats:{maxHp:100,speed:3.5,might:1,area:1,cooldownReduction:0},startingWeaponId:"shadow_bolt",color:"#3b82f6"},{id:"lyra",name:"Lyra",title:"Pyromancer",description:"High damage, low HP. Starts with Plasma Cutter.",unlockCondition:"Kill 500 enemies total.",isUnlocked:o=>o.totalKills>=500,baseStats:{maxHp:70,speed:4,might:1.3,area:1.1,cooldownReduction:0},startingWeaponId:"plasma_cutter",color:"#fb923c"},{id:"grom",name:"Grom",title:"Ironclad",description:"Very tanky, slow. Starts with Obsidian Shard.",unlockCondition:"Survive for 10 minutes total.",isUnlocked:o=>o.totalTime>=600,baseStats:{maxHp:160,speed:2.8,might:1.1,area:1.2,cooldownReduction:0},startingWeaponId:"obsidian_shard",color:"#475569"},{id:"vex",name:"Vex",title:"Void Soul",description:"Fast cooldowns, fragile. Starts with Spectral Shield.",unlockCondition:"Reach Level 10 in a single run.",isUnlocked:o=>o.maxLevel>=10,baseStats:{maxHp:50,speed:3.8,might:.9,area:1,cooldownReduction:.2},startingWeaponId:"spectral_shield",color:"#a855f7"},{id:"seraphina",name:"Seraphina",title:"Wind Dancer",description:"Incredibly fast. High cooldown reduction. Starts with Spectral Shield.",unlockCondition:"Collect 1000 gems in total.",isUnlocked:o=>(o.totalGems||0)>=1e3,baseStats:{maxHp:60,speed:4.5,might:.9,area:1,cooldownReduction:.25},startingWeaponId:"spectral_shield",color:"#f472b6"},{id:"darius",name:"Darius",title:"Crimson Lord",description:"Sustains through bloodshed. Starts with Blood Siphon.",unlockCondition:"Kill 1500 enemies total.",isUnlocked:o=>o.totalKills>=1500,baseStats:{maxHp:140,speed:3.2,might:1,area:1,cooldownReduction:0},startingWeaponId:"blood_siphon",color:"#dc2626"},{id:"isolde",name:"Isolde",title:"Frost Queen",description:"Master of cold. Starts with Frost Nova.",unlockCondition:"Reach Level 25 in a single run.",isUnlocked:o=>o.maxLevel>=25,baseStats:{maxHp:80,speed:3.4,might:1.1,area:1.3,cooldownReduction:.1},startingWeaponId:"frost_nova",color:"#06b6d4"},{id:"grimwald",name:"Grimwald",title:"The Executioner",description:"Brutal melee fighter. Starts with Whirling Axe.",unlockCondition:"Kill 3000 enemies total.",isUnlocked:o=>o.totalKills>=3e3,baseStats:{maxHp:150,speed:3,might:1.4,area:1,cooldownReduction:0},startingWeaponId:"whirling_axe",color:"#d97706"},{id:"ignis",name:"Ignis",title:"The Bombardier",description:"Explosive expert. Starts with Inferno Grenade.",unlockCondition:"Kill 4000 enemies total.",isUnlocked:o=>o.totalKills>=4e3,baseStats:{maxHp:120,speed:2.6,might:1.5,area:1.2,cooldownReduction:0},startingWeaponId:"inferno_grenade",color:"#b91c1c"},{id:"elara",name:"Elara",title:"Phantom Blade",description:"Swift and deadly. Starts with Phantom Daggers.",unlockCondition:"Survive for 25 minutes total.",isUnlocked:o=>o.totalTime>=1500,baseStats:{maxHp:75,speed:4.2,might:1.1,area:1,cooldownReduction:.1},startingWeaponId:"phantom_daggers",color:"#cbd5e1"}],M={shadow_bolt:{name:"Shadow Bolt",description:"Fires energy bolts at nearest enemy.",unlockCondition:()=>!0,unlockText:"Unlocked"},obsidian_shard:{name:"Obsidian Shard",description:"Lobs heavy rocks in a high arc.",unlockCondition:o=>o.maxLevel>=5,unlockText:"Reach Level 5."},spectral_shield:{name:"Spectral Shield",description:"Revolving energy crystals protect you.",unlockCondition:o=>o.totalKills>=200,unlockText:"Kill 200 enemies."},corrosive_aura:{name:"Corrosive Aura",description:"Creates a toxic zone around you.",unlockCondition:o=>o.totalTime>=300,unlockText:"Survive 5 minutes."},thunder_strike:{name:"Thunder Strike",description:"Calls down orbital lightning strikes.",unlockCondition:o=>o.bossesKilled>=1,unlockText:"Kill a Boss."},plasma_cutter:{name:"Plasma Cutter",description:"Shoots a piercing wave horizontally.",unlockCondition:o=>o.gamesPlayed>=3,unlockText:"Play 3 games."},blood_siphon:{name:"Blood Siphon",description:"Projectile that heals you on hit.",unlockCondition:o=>o.totalKills>=1e3,unlockText:"Kill 1000 enemies."},frost_nova:{name:"Frost Nova",description:"Emits a freezing pulse that damages nearby enemies.",unlockCondition:o=>o.maxLevel>=15,unlockText:"Reach Level 15."},whirling_axe:{name:"Whirling Axe",description:"Spirals outward, slicing everything in its path.",unlockCondition:o=>o.totalKills>=2500,unlockText:"Kill 2500 enemies."},flame_breath:{name:"Flame Breath",description:"Spews a cone of fire in front of you.",unlockCondition:o=>o.totalTime>=1200,unlockText:"Survive 20 minutes."},void_trap:{name:"Void Trap",description:"Places a zone that damages enemies inside it.",unlockCondition:o=>o.gamesPlayed>=5,unlockText:"Play 5 games."},ricochet_blade:{name:"Ricochet Blade",description:"Bounces between multiple enemies.",unlockCondition:o=>(o.maxKills||0)>=300,unlockText:"Get 300 kills in one run."},vortex_orb:{name:"Vortex Orb",description:"Pulls nearby enemies into a crushing void.",unlockCondition:o=>o.maxLevel>=30,unlockText:"Reach Level 30."},inferno_grenade:{name:"Inferno Grenade",description:"Explodes on impact, dealing massive area damage.",unlockCondition:o=>o.totalKills>=4e3,unlockText:"Kill 4000 enemies."},phantom_daggers:{name:"Phantom Daggers",description:"Fires a spread of daggers behind you.",unlockCondition:o=>o.totalTime>=1500,unlockText:"Survive 25 minutes."}},G=[{id:"novice_hunter",title:"Novice Hunter",description:"Kill 500 enemies in total.",condition:o=>o.totalKills>=500,icon:"ðŸ—¡ï¸"},{id:"veteran_slayer",title:"Veteran Slayer",description:"Kill 5,000 enemies in total.",condition:o=>o.totalKills>=5e3,icon:"ðŸ’€"},{id:"elite_slayer",title:"Elite Slayer",description:"Kill 20,000 enemies in total.",condition:o=>o.totalKills>=2e4,icon:"ðŸ©¸"},{id:"gold_rush",title:"Gold Rush",description:"Collect 5,000 Gold total.",condition:o=>(o.gold||0)>=5e3,icon:"ðŸª™"},{id:"midas_touch",title:"Midas Touch",description:"Collect 50,000 Gold total.",condition:o=>(o.gold||0)>=5e4,icon:"ðŸ‘‘"},{id:"rampage",title:"Rampage",description:"Kill 1,500 enemies in a single run.",condition:o=>(o.maxKills||0)>=1500,icon:"ðŸŒªï¸"},{id:"annihilator",title:"Annihilator",description:"Kill 3,000 enemies in a single run.",condition:o=>(o.maxKills||0)>=3e3,icon:"â˜„ï¸"},{id:"weapon_collector",title:"Weapon Collector",description:"Unlock 5 different weapons.",condition:o=>Object.values(M).filter(t=>t.unlockCondition(o)).length>=5,icon:"ðŸ›¡ï¸"},{id:"master_of_arms",title:"Master of Arms",description:"Unlock 10 different weapons.",condition:o=>Object.values(M).filter(t=>t.unlockCondition(o)).length>=10,icon:"âš”ï¸"},{id:"seasoned_veteran",title:"Seasoned Veteran",description:"Play 50 games.",condition:o=>o.gamesPlayed>=50,icon:"ðŸŽ–ï¸"},{id:"immortal",title:"Immortal",description:"Play for a total of 5 hours.",condition:o=>o.totalTime>=18e3,icon:"ðŸ•°ï¸"},{id:"technomancer",title:"Technomancer",description:"Purchase 20 Power Up levels.",condition:o=>Object.values(o.powerUps||{}).reduce((t,i)=>t+i,0)>=20,icon:"ðŸ’¸"},{id:"survivor",title:"Survivor",description:"Survive for a total of 30 minutes.",condition:o=>o.totalTime>=1800,icon:"â³"},{id:"marathon",title:"Marathon",description:"Play for a total of 2 hours.",condition:o=>o.totalTime>=7200,icon:"ðŸƒ"},{id:"awakened",title:"Awakened",description:"Reach Level 20 in a single run.",condition:o=>o.maxLevel>=20,icon:"âœ¨"},{id:"master_survivor",title:"Master Survivor",description:"Reach Level 40 in a single run.",condition:o=>o.maxLevel>=40,icon:"ðŸŒŸ"},{id:"boss_slayer",title:"Boss Slayer",description:"Defeat a Boss.",condition:o=>o.bossesKilled>=1,icon:"ðŸ‘‘"},{id:"boss_hunter",title:"Boss Hunter",description:"Defeat 5 Bosses total.",condition:o=>o.bossesKilled>=5,icon:"ðŸ‘¹"},{id:"treasure_hunter",title:"Treasure Hunter",description:"Collect 2,000 gems in total.",condition:o=>(o.totalGems||0)>=2e3,icon:"ðŸ’Ž"},{id:"gem_hoarder",title:"Gem Hoarder",description:"Collect 10,000 gems in total.",condition:o=>(o.totalGems||0)>=1e4,icon:"ðŸ’°"},{id:"dedicated",title:"Dedicated",description:"Play 10 games.",condition:o=>o.gamesPlayed>=10,icon:"ðŸŽ®"}],w="crimson_survivor_stats_v3",k={totalKills:0,totalTime:0,maxLevel:1,gamesPlayed:0,bossesKilled:0,unlockedWeapons:["shadow_bolt"],totalGems:0,maxKills:0,gold:0,powerUps:{}},I=()=>{try{const o=localStorage.getItem(w);if(!o)return k;const t=JSON.parse(o);return{...k,...t}}catch(o){return console.error("Failed to load stats",o),k}},N=o=>{const t=I();let i={...t};o&&(i={...t,totalKills:t.totalKills+o.kills,totalTime:t.totalTime+o.time,maxLevel:Math.max(t.maxLevel,o.level),gamesPlayed:t.gamesPlayed+1,bossesKilled:t.bossesKilled+(o.bossKilled?1:0),totalGems:(t.totalGems||0)+o.gemsCollected,maxKills:Math.max(t.maxKills||0,o.kills),gold:(t.gold||0)+o.goldCollected});try{localStorage.setItem(w,JSON.stringify(i))}catch(s){console.error("Failed to save stats",s)}return i},U=o=>{try{localStorage.setItem(w,JSON.stringify(o))}catch(t){console.error("Failed to save stats",t)}};var x=(o=>(o.PLAYER="PLAYER",o.ENEMY="ENEMY",o.GEM="GEM",o.CHEST="CHEST",o.PROJECTILE="PROJECTILE",o.TEXT_PARTICLE="TEXT_PARTICLE",o.VISUAL_PARTICLE="VISUAL_PARTICLE",o.AURA="AURA",o.DESTRUCTIBLE="DESTRUCTIBLE",o.PICKUP="PICKUP",o))(x||{}),g=(o=>(o.BAT="BAT",o.ZOMBIE="ZOMBIE",o.SKELETON="SKELETON",o.GHOST="GHOST",o.BOSS="BOSS",o))(g||{}),P=(o=>(o.GOLD="GOLD",o.CHICKEN="CHICKEN",o.VACUUM="VACUUM",o.ROSARY="ROSARY",o))(P||{});class F{constructor(t){f(this,"cellSize");f(this,"cells");this.cellSize=t,this.cells=new Map}clear(){this.cells.clear()}insert(t){const i=this.getKey(t.pos);this.cells.has(i)||this.cells.set(i,[]),this.cells.get(i).push(t)}getNearby(t){const i=[],s=Math.floor(t.x/this.cellSize),a=Math.floor(t.y/this.cellSize);for(let l=s-1;l<=s+1;l++)for(let r=a-1;r<=a+1;r++){const n=`${l},${r}`,d=this.cells.get(n);if(d)for(let h=0;h<d.length;h++)i.push(d[h])}return i}getKey(t){const i=Math.floor(t.x/this.cellSize),s=Math.floor(t.y/this.cellSize);return`${i},${s}`}}class H{constructor(t,i,s,a,l,r){f(this,"canvas");f(this,"ctx");f(this,"bgPattern",null);f(this,"player");f(this,"enemies",[]);f(this,"gems",[]);f(this,"chests",[]);f(this,"destructibles",[]);f(this,"pickups",[]);f(this,"projectiles",[]);f(this,"damageTexts",[]);f(this,"particles",[]);f(this,"keys",new Set);f(this,"frameCount",0);f(this,"score",0);f(this,"gemsCollected",0);f(this,"goldCollected",0);f(this,"isPaused",!1);f(this,"isGameOver",!1);f(this,"bossKilled",!1);f(this,"isRunning",!1);f(this,"lastTime",0);f(this,"accumulator",0);f(this,"FIXED_TIME_STEP",1e3/60);f(this,"enemyGrid");f(this,"onLevelUp");f(this,"onGameOver");f(this,"onBossSpawn");f(this,"onChestOpen");f(this,"handleKeyDown",t=>this.keys.add(t.code));f(this,"handleKeyUp",t=>this.keys.delete(t.code));f(this,"handleResize",()=>{const t=window.devicePixelRatio||1;this.canvas.width=window.innerWidth*t,this.canvas.height=window.innerHeight*t,this.ctx.scale(t,t),this.createBackgroundPattern()});this.canvas=t,this.ctx=t.getContext("2d",{alpha:!1}),this.onLevelUp=s,this.onGameOver=a,this.onBossSpawn=l,this.onChestOpen=r,this.enemyGrid=new F(120);const n=window.devicePixelRatio||1;this.canvas.width=window.innerWidth*n,this.canvas.height=window.innerHeight*n,this.ctx.scale(n,n),this.createBackgroundPattern(),this.player=this.createPlayer(i),this.loop=this.loop.bind(this),window.addEventListener("keydown",this.handleKeyDown),window.addEventListener("keyup",this.handleKeyUp),window.addEventListener("resize",this.handleResize)}destroy(){this.isRunning=!1,window.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("keyup",this.handleKeyUp),window.removeEventListener("resize",this.handleResize)}createBackgroundPattern(){const i=document.createElement("canvas");i.width=256,i.height=256;const s=i.getContext("2d");s.fillStyle="#0a0a0c",s.fillRect(0,0,256,256);for(let a=0;a<40;a++){s.fillStyle=Math.random()>.5?"#111113":"#050505";const l=Math.random()*40+10;s.fillRect(Math.random()*256,Math.random()*256,l,l)}s.strokeStyle="#1a1a1e",s.lineWidth=2,s.beginPath(),s.moveTo(0,256),s.lineTo(256,0),s.stroke(),s.strokeStyle="#141416",s.lineWidth=1,s.strokeRect(0,0,256,256),this.bgPattern=this.ctx.createPattern(i,"repeat")}createPlayer(t){const i=A.find(v=>v.id===t)||A[0],s=I();let a=0,l=0,r=0,n=0,d=0,h=0,p=0,y=0,m=0,e=0;B.forEach(v=>{const u=(s.powerUps[v.id]||0)*v.valuePerLevel;switch(v.statKey){case"might":a+=u;break;case"maxHp":l+=i.baseStats.maxHp*u;break;case"recovery":r+=u;break;case"cooldownReduction":n+=u;break;case"area":d+=u;break;case"speed":h+=u;break;case"growth":p+=u;break;case"greed":y+=u;break;case"luck":m+=u;break;case"magnet":e+=u;break}});const c=this.getWeaponConfig(i.startingWeaponId);return{id:"player",type:x.PLAYER,characterId:i.id,pos:{x:window.innerWidth/2,y:window.innerHeight/2},radius:12,color:i.color,markedForDeletion:!1,hp:i.baseStats.maxHp+l,maxHp:i.baseStats.maxHp+l,speed:i.baseStats.speed,pickupRange:100*(1+e),weapons:[c],passives:[],xp:0,level:1,nextLevelXp:50,facingRight:!0,stats:{might:i.baseStats.might+a,cooldownReduction:Math.min(.5,i.baseStats.cooldownReduction+n),area:i.baseStats.area+d,speed:1+h,lifesteal:i.baseStats.lifesteal||0,greed:1+y,growth:1+p,luck:m,recovery:r,amount:0,moveSpeed:1,magnet:1+e}}}getWeaponConfig(t){switch(t){case"shadow_bolt":return{id:t,name:"Shadow Bolt",description:"Fires energy bolts.",level:1,maxLevel:8,cooldown:50,cooldownTimer:0,damage:15,area:1,speed:7,duration:60,amount:1,type:"PROJECTILE"};case"umbral_barrage":return{id:t,name:"Umbral Barrage",description:"Evolution: Void destruction.",level:1,maxLevel:1,cooldown:45,cooldownTimer:0,damage:25,area:1.5,speed:8,duration:80,amount:5,type:"PROJECTILE"};case"obsidian_shard":return{id:t,name:"Obsidian Shard",description:"Heavy lobbed projectile.",level:1,maxLevel:8,cooldown:80,cooldownTimer:0,damage:35,area:1.5,speed:1,duration:120,amount:1,type:"PROJECTILE"};case"spectral_shield":return{id:t,name:"Spectral Shield",description:"Orbiting crystals.",level:1,maxLevel:8,cooldown:180,cooldownTimer:0,damage:15,area:1.2,speed:1,duration:180,amount:1,type:"ORBITAL"};case"corrosive_aura":return{id:t,name:"Corrosive Aura",description:"Toxic zone.",level:1,maxLevel:8,cooldown:30,cooldownTimer:0,damage:5,area:1.2,speed:0,duration:0,amount:1,type:"AURA"};case"thunder_strike":return{id:t,name:"Thunder Strike",description:"Orbital lightning.",level:1,maxLevel:8,cooldown:90,cooldownTimer:0,damage:50,area:1,speed:0,duration:0,amount:2,type:"INSTANT"};case"plasma_cutter":return{id:t,name:"Plasma Cutter",description:"Horizontal wave.",level:1,maxLevel:8,cooldown:60,cooldownTimer:0,damage:25,area:1,speed:8,duration:100,amount:1,type:"PROJECTILE"};case"blood_siphon":return{id:t,name:"Blood Siphon",description:"Heals on hit.",level:1,maxLevel:8,cooldown:70,cooldownTimer:0,damage:10,area:1,speed:6,duration:60,amount:1,type:"PROJECTILE"};case"frost_nova":return{id:t,name:"Frost Nova",description:"Freezing pulse.",level:1,maxLevel:8,cooldown:180,cooldownTimer:0,damage:10,area:1.5,speed:0,duration:0,amount:1,type:"INSTANT"};case"whirling_axe":return{id:t,name:"Whirling Axe",description:"Spiraling projectile.",level:1,maxLevel:8,cooldown:120,cooldownTimer:0,damage:20,area:1,speed:5,duration:150,amount:1,type:"PROJECTILE"};case"flame_breath":return{id:t,name:"Flame Breath",description:"Spews a cone of fire in front of you.",level:1,maxLevel:8,cooldown:90,cooldownTimer:0,damage:8,area:1,speed:5,duration:40,amount:3,type:"PROJECTILE"};case"void_trap":return{id:t,name:"Void Trap",description:"Static damaging zone.",level:1,maxLevel:8,cooldown:200,cooldownTimer:0,damage:4,area:1,speed:0,duration:300,amount:1,type:"PROJECTILE"};case"ricochet_blade":return{id:t,name:"Ricochet Blade",description:"Bouncing blade.",level:1,maxLevel:8,cooldown:70,cooldownTimer:0,damage:15,area:1,speed:7,duration:180,amount:1,type:"PROJECTILE"};case"vortex_orb":return{id:t,name:"Vortex Orb",description:"Pulls enemies in.",level:1,maxLevel:8,cooldown:180,cooldownTimer:0,damage:5,area:1.2,speed:2,duration:180,amount:1,type:"PROJECTILE"};case"inferno_grenade":return{id:t,name:"Inferno Grenade",description:"Explodes on impact.",level:1,maxLevel:8,cooldown:100,cooldownTimer:0,damage:40,area:1.5,speed:1,duration:80,amount:1,type:"PROJECTILE"};case"phantom_daggers":return{id:t,name:"Phantom Daggers",description:"Fires backwards.",level:1,maxLevel:8,cooldown:45,cooldownTimer:0,damage:15,area:1,speed:8,duration:80,amount:2,type:"PROJECTILE"};default:return{id:t,name:"Unknown",description:"?",level:1,maxLevel:1,cooldown:100,cooldownTimer:0,damage:1,area:1,speed:1,duration:1,amount:1,type:"PROJECTILE"}}}start(){this.isRunning=!0,this.lastTime=performance.now(),requestAnimationFrame(this.loop)}loop(t){if(!this.isRunning)return;if(requestAnimationFrame(this.loop),this.isPaused||this.isGameOver){this.lastTime=t;return}const i=t-this.lastTime;if(this.lastTime=t,i>250){this.accumulator=0;return}this.accumulator+=i;let s=0;for(;this.accumulator>=this.FIXED_TIME_STEP;)if(this.update(),this.accumulator-=this.FIXED_TIME_STEP,s++,s>240){this.accumulator=0;break}this.draw()}update(){this.frameCount++,this.enemyGrid.clear();const t=this.enemies.length;for(let a=0;a<t;a++){const l=this.enemies[a];l.markedForDeletion||this.enemyGrid.insert(l)}this.player.stats.recovery>0&&this.frameCount%60===0&&(this.player.hp=Math.min(this.player.maxHp,this.player.hp+this.player.stats.recovery));let i=0,s=0;if((this.keys.has("ArrowUp")||this.keys.has("KeyW"))&&(s-=1),(this.keys.has("ArrowDown")||this.keys.has("KeyS"))&&(s+=1),(this.keys.has("ArrowLeft")||this.keys.has("KeyA"))&&(i-=1,this.player.facingRight=!1),(this.keys.has("ArrowRight")||this.keys.has("KeyD"))&&(i+=1,this.player.facingRight=!0),i!==0||s!==0){const a=Math.sqrt(i*i+s*s),l=this.player.speed*this.player.stats.moveSpeed;this.player.pos.x+=i/a*l,this.player.pos.y+=s/a*l}(isNaN(this.player.pos.x)||isNaN(this.player.pos.y))&&(this.player.pos={x:window.innerWidth/2,y:window.innerHeight/2}),this.handleSpawning(),this.updateEnemies(),this.updateProjectiles(),this.updateGems(),this.updateWeapons(),this.updateParticles(),this.updateChests(),this.updateDestructibles(),this.updatePickups(),this.checkCollisions(),this.cleanup()}handleSpawning(){const t=1+this.frameCount/3600,i=Math.max(5,Math.floor(50/t));this.frameCount%i===0&&this.spawnEnemy(),this.frameCount>0&&this.frameCount%3600===0&&this.spawnBoss(),this.frameCount%300===0&&this.destructibles.length<10&&this.spawnDestructible()}spawnEnemy(){const t=Math.random()*Math.PI*2,i=Math.max(window.innerWidth,window.innerHeight)/2+100,s={x:this.player.pos.x+Math.cos(t)*i,y:this.player.pos.y+Math.sin(t)*i};let a=g.BAT;const l=this.frameCount/3600,r=Math.random();l>5?r<.2?a=g.GHOST:r<.5?a=g.SKELETON:a=g.ZOMBIE:l>2?r<.1?a=g.GHOST:r<.6?a=g.SKELETON:a=g.ZOMBIE:l>1&&(r<.6?a=g.ZOMBIE:a=g.BAT);const n=L[a];this.enemies.push({id:Math.random().toString(36),type:x.ENEMY,enemyType:a,pos:s,radius:n.radius,color:n.color,hp:n.hp*(1+l*.4),maxHp:n.hp*(1+l*.4),speed:n.speed+l*.1,damage:n.damage,xpValue:n.xp,opacity:a===g.GHOST?.6:1,markedForDeletion:!1,animationOffset:Math.random()*Math.PI*2,visualVariant:Math.floor(Math.random()*3)})}spawnDestructible(){const t=Math.random()*Math.PI*2,i=400+Math.random()*200;this.destructibles.push({id:"dest_"+Date.now(),type:x.DESTRUCTIBLE,pos:{x:this.player.pos.x+Math.cos(t)*i,y:this.player.pos.y+Math.sin(t)*i},hp:1,radius:15,color:b.destructible,markedForDeletion:!1})}spawnBoss(){const t=Math.random()*Math.PI*2,i=Math.max(window.innerWidth,window.innerHeight)/2+150,s=L.BOSS;this.enemies.push({id:"boss-"+Date.now(),type:x.ENEMY,enemyType:g.BOSS,pos:{x:this.player.pos.x+Math.cos(t)*i,y:this.player.pos.y+Math.sin(t)*i},radius:s.radius,color:s.color,hp:s.hp*(1+this.frameCount/3600*.8),maxHp:s.hp,speed:s.speed,damage:s.damage,xpValue:s.xp,markedForDeletion:!1,animationOffset:0,visualVariant:0}),this.onBossSpawn()}updateEnemies(){this.enemies.forEach(t=>{if(t.stunTimer&&t.stunTimer>0){t.stunTimer--;return}const i=this.player.pos.x-t.pos.x,s=this.player.pos.y-t.pos.y,a=Math.sqrt(i*i+s*s);a>0&&(t.pos.x+=i/a*t.speed,t.pos.y+=s/a*t.speed);const l=this.enemyGrid.getNearby(t.pos);for(const r of l){if(t===r||Math.abs(t.pos.x-r.pos.x)>40||Math.abs(t.pos.y-r.pos.y)>40)continue;const n=t.pos.x-r.pos.x,d=t.pos.y-r.pos.y,h=Math.sqrt(n*n+d*d);h<t.radius+r.radius&&h>0&&(t.pos.x+=n/h*.05,t.pos.y+=d/h*.05)}})}updateProjectiles(){this.projectiles.forEach(t=>{t.behavior==="STRAIGHT"?(t.pos.x+=t.velocity.x,t.pos.y+=t.velocity.y):t.behavior==="ARC"?(t.pos.x+=t.velocity.x,t.pos.y+=t.velocity.y,t.gravity&&(t.velocity.y+=t.gravity)):t.behavior==="ORBIT"?t.orbitAngle!==void 0&&t.orbitDistance!==void 0&&t.orbitSpeed!==void 0&&(t.orbitAngle+=t.orbitSpeed,t.orbitGrowth&&t.orbitGrowth>0&&(t.orbitDistance+=t.orbitGrowth),t.pos.x=this.player.pos.x+Math.cos(t.orbitAngle)*t.orbitDistance,t.pos.y=this.player.pos.y+Math.sin(t.orbitAngle)*t.orbitDistance):t.behavior,t.pullRadius&&t.pullForce&&this.enemies.forEach(i=>{const s=t.pos.x-i.pos.x,a=t.pos.y-i.pos.y,l=Math.sqrt(s*s+a*a);l<t.pullRadius&&(i.pos.x+=s/l*t.pullForce,i.pos.y+=a/l*t.pullForce)}),t.duration===1&&t.onHitEffect==="EXPLODE"&&this.triggerExplosion(t),t.duration--,t.duration<=0&&(t.markedForDeletion=!0)})}updateGems(){this.gems.forEach(t=>{const i=this.player.pos.x-t.pos.x,s=this.player.pos.y-t.pos.y,a=Math.sqrt(i*i+s*s),l=this.player.pickupRange*this.player.stats.magnet;if(t.isVacuumed||a<l){const r=t.isVacuumed?15:8+(l-a)*.1;t.pos.x+=i/a*r,t.pos.y+=s/a*r,a<this.player.radius&&(this.player.xp+=t.value*this.player.stats.growth,this.gemsCollected++,t.markedForDeletion=!0,this.checkLevelUp())}})}updateDestructibles(){}updatePickups(){this.pickups.forEach(t=>{const i=this.player.pos.x-t.pos.x,s=this.player.pos.y-t.pos.y,a=Math.sqrt(i*i+s*s),l=this.player.pickupRange*this.player.stats.magnet;a<l&&(t.pos.x+=i/a*8,t.pos.y+=s/a*8,a<this.player.radius&&(this.applyPickupEffect(t),t.markedForDeletion=!0))})}applyPickupEffect(t){switch(t.pickupType){case P.GOLD:const i=Math.ceil(t.value*this.player.stats.greed);this.goldCollected+=i,this.addDamageText(this.player.pos,i,!1,"HEAL");break;case P.CHICKEN:this.player.hp=Math.min(this.player.maxHp,this.player.hp+t.value),this.addDamageText(this.player.pos,t.value,!1,"HEAL");break;case P.VACUUM:this.gems.forEach(l=>l.isVacuumed=!0);break;case P.ROSARY:const s=window.innerWidth,a=window.innerHeight;this.enemies.forEach(l=>{l.enemyType!==g.BOSS&&Math.abs(l.pos.x-this.player.pos.x)<s/2+100&&Math.abs(l.pos.y-this.player.pos.y)<a/2+100&&(l.hp=0,this.handleEnemyDeath(l))}),this.particles.push({id:Math.random().toString(),type:x.VISUAL_PARTICLE,pos:{...this.player.pos},life:10,maxLife:10,renderType:"EXPLOSION",radius:0,color:"#fff",markedForDeletion:!1});break}}updateChests(){this.chests.forEach(t=>{const i=this.player.pos.x-t.pos.x,s=this.player.pos.y-t.pos.y;Math.sqrt(i*i+s*s)<this.player.radius+t.radius&&(t.markedForDeletion=!0,this.isPaused=!0,this.onChestOpen())})}updateParticles(){this.particles.forEach(t=>{t.velocity&&(t.pos.x+=t.velocity.x,t.pos.y+=t.velocity.y,t.velocity.x*=.95,t.velocity.y*=.95),t.gravity&&(t.velocity||(t.velocity={x:0,y:0}),t.velocity.y+=t.gravity),t.life--,t.life<=0&&(t.markedForDeletion=!0)}),this.damageTexts.forEach(t=>{t.pos.x+=t.velocity.x,t.pos.y+=t.velocity.y,t.life-=.02,t.opacity=Math.max(0,t.life),t.life<=0&&(t.markedForDeletion=!0)})}updateWeapons(){this.player.weapons.forEach(t=>{const i=t.cooldown*(1-this.player.stats.cooldownReduction),s=t.amount+this.player.stats.amount;if(t.cooldownTimer>0&&t.cooldownTimer--,t.cooldownTimer<=0)if(t.id==="shadow_bolt")this.fireShadowBolt(t,s),t.cooldownTimer=i;else if(t.id==="umbral_barrage")this.fireUmbralBarrage(t,s),t.cooldownTimer=i;else if(t.id==="obsidian_shard"){for(let a=0;a<s;a++){const l=(a-(s-1)/2)*.3;this.fireObsidian(t,l)}t.cooldownTimer=i}else if(t.id==="corrosive_aura")this.pulseCorrosive(t),t.cooldownTimer=i;else if(t.id==="thunder_strike")this.strikeThunder(t,s),t.cooldownTimer=i;else if(t.id==="plasma_cutter")this.firePlasma(t),t.cooldownTimer=i;else if(t.id==="blood_siphon")this.fireBloodSiphon(t,s),t.cooldownTimer=i;else if(t.id==="frost_nova")this.fireFrostNova(t),t.cooldownTimer=i;else if(t.id==="whirling_axe"){for(let a=0;a<s;a++)setTimeout(()=>this.spawnWhirlingAxe(t,a,s),a*500);t.cooldownTimer=i}else t.id==="flame_breath"?(this.fireFlameBreath(t,s),t.cooldownTimer=i):t.id==="void_trap"?(this.spawnVoidTrap(t),t.cooldownTimer=i):t.id==="ricochet_blade"?(this.fireRicochetBlade(t),t.cooldownTimer=i):t.id==="vortex_orb"?(this.fireVortexOrb(t),t.cooldownTimer=i):t.id==="inferno_grenade"?(this.fireInfernoGrenade(t),t.cooldownTimer=i):t.id==="phantom_daggers"&&(this.firePhantomDaggers(t,s),t.cooldownTimer=i);if(t.id==="spectral_shield"&&this.projectiles.filter(l=>l.weaponId==="spectral_shield"&&!l.markedForDeletion).length<s&&t.cooldownTimer<=0){for(let l=0;l<s;l++)this.spawnShield(t,l,s);t.cooldownTimer=i+t.duration}})}fireShadowBolt(t,i){this.genericFire(t,i,"STRAIGHT",b.shadowBolt)}fireUmbralBarrage(t,i){const s=this.getNearestEnemy();if(!s)return;const a=s.pos.x-this.player.pos.x,l=s.pos.y-this.player.pos.y,r=Math.atan2(l,a);for(let n=0;n<i;n++){const h=r-.2*(i-1)/2+.2*n,p=Math.cos(h),y=Math.sin(h);this.projectiles.push({id:Math.random().toString(36),type:x.PROJECTILE,pos:{...this.player.pos},velocity:{x:p*t.speed*this.player.stats.speed,y:y*t.speed*this.player.stats.speed},damage:t.damage*this.player.stats.might,duration:120,pierce:3,radius:8*this.player.stats.area,color:b.umbralBarrage,markedForDeletion:!1,weaponId:t.id,behavior:"STRAIGHT",knockback:8})}}fireObsidian(t,i){const a=(this.player.facingRight?3:-3)+i*4;this.projectiles.push({id:Math.random().toString(36),type:x.PROJECTILE,pos:{x:this.player.pos.x,y:this.player.pos.y-20},velocity:{x:a*this.player.stats.speed,y:-9*this.player.stats.speed},damage:t.damage*this.player.stats.might*1.5,duration:120,pierce:999,radius:10*this.player.stats.area,color:b.obsidianShard,markedForDeletion:!1,weaponId:t.id,behavior:"ARC",gravity:.25,knockback:10})}spawnShield(t,i,s){const a=Math.PI*2*i/s,l=80*this.player.stats.area;this.projectiles.push({id:Math.random().toString(36),type:x.PROJECTILE,pos:{x:this.player.pos.x,y:this.player.pos.y},velocity:{x:0,y:0},damage:t.damage*this.player.stats.might,duration:t.duration,pierce:999,radius:8,color:b.spectralShield,markedForDeletion:!1,weaponId:t.id,behavior:"ORBIT",orbitAngle:a,orbitDistance:l,orbitSpeed:.05*this.player.stats.speed,knockback:15})}pulseCorrosive(t){const i=t.area*50*this.player.stats.area;this.enemies.forEach(s=>{if(Math.hypot(s.pos.x-this.player.pos.x,s.pos.y-this.player.pos.y)<i+s.radius){this.applyDamage(s,t.damage*this.player.stats.might,t.id);const l=1,r=Math.atan2(s.pos.y-this.player.pos.y,s.pos.x-this.player.pos.x);s.pos.x+=Math.cos(r)*l,s.pos.y+=Math.sin(r)*l,s.hp<=0&&!s.markedForDeletion&&this.handleEnemyDeath(s)}})}strikeThunder(t,i){const s=this.enemies.filter(a=>{const l=Math.abs(a.pos.x-this.player.pos.x),r=Math.abs(a.pos.y-this.player.pos.y);return l<window.innerWidth/2&&r<window.innerHeight/2});if(s.length!==0)for(let a=0;a<i&&s.length!==0;a++){const l=Math.floor(Math.random()*s.length),r=s.splice(l,1)[0];this.applyDamage(r,t.damage*this.player.stats.might,t.id),r.hp<=0&&!r.markedForDeletion&&this.handleEnemyDeath(r),this.particles.push({id:Math.random().toString(),type:x.VISUAL_PARTICLE,pos:{x:r.pos.x,y:r.pos.y-300},targetPos:{x:r.pos.x,y:r.pos.y},life:15,maxLife:15,renderType:"LIGHTNING",width:3*this.player.stats.area,radius:0,color:b.thunderStrike,markedForDeletion:!1})}}firePlasma(t){const i=this.player.facingRight?1:-1;this.projectiles.push({id:Math.random().toString(36),type:x.PROJECTILE,pos:{x:this.player.pos.x,y:this.player.pos.y},velocity:{x:i*t.speed*this.player.stats.speed,y:0},damage:t.damage*this.player.stats.might,duration:t.duration,pierce:999,radius:20*this.player.stats.area,color:b.plasmaCutter,markedForDeletion:!1,weaponId:t.id,behavior:"STRAIGHT",knockback:12})}fireBloodSiphon(t,i){const s=this.getNearestEnemy();if(s)for(let a=0;a<i;a++)setTimeout(()=>{s&&!s.markedForDeletion&&this.spawnProjectile(s,t,b.bloodSiphon,1,"STRAIGHT")},a*150)}fireFrostNova(t){const i=150*t.area*this.player.stats.area;this.particles.push({id:Math.random().toString(),type:x.VISUAL_PARTICLE,pos:{...this.player.pos},life:20,maxLife:20,renderType:"FROST_NOVA",radius:i,color:b.frostNova,markedForDeletion:!1}),this.enemies.forEach(s=>{if(Math.hypot(s.pos.x-this.player.pos.x,s.pos.y-this.player.pos.y)<i){this.applyDamage(s,t.damage*this.player.stats.might,t.id);const l=Math.atan2(s.pos.y-this.player.pos.y,s.pos.x-this.player.pos.x);s.pos.x+=Math.cos(l)*30,s.pos.y+=Math.sin(l)*30,s.hp<=0&&!s.markedForDeletion&&this.handleEnemyDeath(s)}})}spawnWhirlingAxe(t,i,s){const a=Math.PI*2*i/s;this.projectiles.push({id:Math.random().toString(36),type:x.PROJECTILE,pos:{...this.player.pos},velocity:{x:0,y:0},damage:t.damage*this.player.stats.might,duration:t.duration,pierce:999,radius:12*this.player.stats.area,color:b.whirlingAxe,markedForDeletion:!1,weaponId:t.id,behavior:"ORBIT",orbitAngle:a,orbitDistance:10,orbitGrowth:4,orbitSpeed:.15*this.player.stats.speed,knockback:10})}fireFlameBreath(t,i){const s=this.player.facingRight?0:Math.PI;for(let a=0;a<i;a++)setTimeout(()=>{const l=(Math.random()-.5)*.5,r=s+l,n=Math.cos(r),d=Math.sin(r);this.projectiles.push({id:Math.random().toString(36),type:x.PROJECTILE,pos:{...this.player.pos},velocity:{x:n*t.speed*this.player.stats.speed,y:d*t.speed*this.player.stats.speed},damage:t.damage*this.player.stats.might,duration:t.duration,pierce:999,radius:8*this.player.stats.area,color:b.flameBreath,markedForDeletion:!1,weaponId:t.id,behavior:"STRAIGHT",knockback:2})},a*50)}spawnVoidTrap(t){this.projectiles.push({id:Math.random().toString(36),type:x.PROJECTILE,pos:{...this.player.pos},velocity:{x:0,y:0},damage:t.damage*this.player.stats.might,duration:t.duration,pierce:999,radius:60*this.player.stats.area,color:b.voidTrap,markedForDeletion:!1,weaponId:t.id,behavior:"STATIONARY",knockback:0})}fireRicochetBlade(t){const i=this.getNearestEnemy();if(!i)return;const s=i.pos.x-this.player.pos.x,a=i.pos.y-this.player.pos.y,l=Math.hypot(s,a);this.projectiles.push({id:Math.random().toString(36),type:x.PROJECTILE,pos:{...this.player.pos},velocity:{x:s/l*t.speed*this.player.stats.speed,y:a/l*t.speed*this.player.stats.speed},damage:t.damage*this.player.stats.might,duration:180,pierce:3+Math.floor(t.level/2),radius:6*this.player.stats.area,color:b.ricochetBlade,markedForDeletion:!1,weaponId:t.id,behavior:"STRAIGHT",knockback:4,lastHitId:"player"})}fireVortexOrb(t){const i=this.getNearestEnemy();let s=1,a=0;if(i){const l=i.pos.x-this.player.pos.x,r=i.pos.y-this.player.pos.y,n=Math.hypot(l,r);s=l/n,a=r/n}else s=this.player.facingRight?1:-1;this.projectiles.push({id:Math.random().toString(36),type:x.PROJECTILE,pos:{...this.player.pos},velocity:{x:s*t.speed,y:a*t.speed},damage:t.damage*this.player.stats.might,duration:t.duration,pierce:999,radius:10,color:b.vortexOrb,markedForDeletion:!1,weaponId:t.id,behavior:"STRAIGHT",knockback:0,pullRadius:120*t.area*this.player.stats.area,pullForce:1.5})}fireInfernoGrenade(t){const s=this.player.facingRight?4:-4;this.projectiles.push({id:Math.random().toString(36),type:x.PROJECTILE,pos:{x:this.player.pos.x,y:this.player.pos.y-15},velocity:{x:s*this.player.stats.speed,y:-6*this.player.stats.speed},damage:t.damage*this.player.stats.might,duration:t.duration,pierce:1,radius:8,color:b.infernoGrenade,markedForDeletion:!1,weaponId:t.id,behavior:"ARC",gravity:.2,knockback:0,onHitEffect:"EXPLODE"})}firePhantomDaggers(t,i){const s=this.player.facingRight?Math.PI:0;for(let a=0;a<i;a++){const l=(Math.random()-.5)*.4,r=s+l,n=Math.cos(r),d=Math.sin(r);this.projectiles.push({id:Math.random().toString(36),type:x.PROJECTILE,pos:{...this.player.pos},velocity:{x:n*t.speed*this.player.stats.speed,y:d*t.speed*this.player.stats.speed},damage:t.damage*this.player.stats.might,duration:t.duration,pierce:2,radius:4,color:b.phantomDaggers,markedForDeletion:!1,weaponId:t.id,behavior:"STRAIGHT",knockback:4})}}triggerExplosion(t){this.particles.push({id:Math.random().toString(),type:x.VISUAL_PARTICLE,pos:{...t.pos},life:20,maxLife:20,renderType:"EXPLOSION",radius:60*this.player.stats.area,color:"#ef4444",markedForDeletion:!1});const i=60*this.player.stats.area;this.enemyGrid.getNearby(t.pos).forEach(a=>{if(a.type!==x.ENEMY)return;if(Math.hypot(a.pos.x-t.pos.x,a.pos.y-t.pos.y)<i){this.applyDamage(a,t.damage,t.weaponId);const r=Math.atan2(a.pos.y-t.pos.y,a.pos.x-t.pos.x);a.pos.x+=Math.cos(r)*15,a.pos.y+=Math.sin(r)*15,a.hp<=0&&!a.markedForDeletion&&this.handleEnemyDeath(a)}})}genericFire(t,i,s,a){const l=this.getNearestEnemy();if(l)for(let r=0;r<i;r++)setTimeout(()=>{l&&!l.markedForDeletion&&this.spawnProjectile(l,t,a,1,s)},r*100)}getNearestEnemy(){let t=null,i=600;const s=this.player.pos.x,a=this.player.pos.y;for(const l of this.enemies){if(Math.abs(l.pos.x-s)>i||Math.abs(l.pos.y-a)>i)continue;const r=Math.hypot(l.pos.x-s,l.pos.y-a);r<i&&(i=r,t=l)}return t}spawnProjectile(t,i,s,a,l){const r=t.pos.x-this.player.pos.x,n=t.pos.y-this.player.pos.y,d=Math.sqrt(r*r+n*n);this.projectiles.push({id:Math.random().toString(36),type:x.PROJECTILE,pos:{...this.player.pos},velocity:{x:r/d*i.speed*this.player.stats.speed,y:n/d*i.speed*this.player.stats.speed},damage:i.damage*this.player.stats.might,duration:120,pierce:a,radius:6*this.player.stats.area,color:s,markedForDeletion:!1,weaponId:i.id,behavior:l,knockback:5})}handleEnemyDeath(t){t.markedForDeletion=!0,this.spawnBloodParticles(t.pos,t.color),t.enemyType===g.BOSS?(this.bossKilled=!0,this.chests.push({id:Math.random().toString(),type:x.CHEST,pos:{...t.pos},radius:20,color:"#d4af37",markedForDeletion:!1,isRare:Math.random()<.2}),this.enemies.forEach(i=>{i.enemyType!==g.BOSS&&(i.hp=0)})):this.gems.push({id:Math.random().toString(),type:x.GEM,pos:{...t.pos},value:t.xpValue,radius:4,color:b.gem,markedForDeletion:!1}),this.score++}spawnImpactParticles(t,i){for(let a=0;a<4;a++){const l=Math.random()*Math.PI*2,r=Math.random()*2+1;this.particles.push({id:Math.random().toString(),type:x.VISUAL_PARTICLE,pos:{...t},life:15,maxLife:15,renderType:"SPARK",radius:Math.random()*2+1,color:i,markedForDeletion:!1,velocity:{x:Math.cos(l)*r,y:Math.sin(l)*r}})}}spawnBloodParticles(t,i){for(let a=0;a<6;a++){const l=Math.random()*Math.PI*2,r=Math.random()*3+1;this.particles.push({id:Math.random().toString(),type:x.VISUAL_PARTICLE,pos:{...t},life:30,maxLife:30,renderType:"BLOOD",radius:Math.random()*2+2,color:i,markedForDeletion:!1,velocity:{x:Math.cos(l)*r,y:Math.sin(l)*r},gravity:.1})}}spawnCritParticles(t){for(let s=0;s<5;s++){const a=Math.PI*2*s/5,l=4;this.particles.push({id:Math.random().toString(),type:x.VISUAL_PARTICLE,pos:{...t},life:20,maxLife:20,renderType:"CRIT",radius:4,color:"#fbbf24",markedForDeletion:!1,velocity:{x:Math.cos(a)*l,y:Math.sin(a)*l}})}}checkCollisions(){if(this.projectiles.forEach(t=>{this.destructibles.forEach(s=>{Math.hypot(t.pos.x-s.pos.x,t.pos.y-s.pos.y)<s.radius+t.radius&&(s.hp-=t.damage,s.hp<=0&&!s.markedForDeletion&&(s.markedForDeletion=!0,this.spawnPickup(s.pos)),t.markedForDeletion=!0)});const i=this.enemyGrid.getNearby(t.pos);for(const s of i){const a=s;if(t.markedForDeletion||a.markedForDeletion)continue;let l=!1;if(t.weaponId==="plasma_cutter"){const r=t.radius*2,n=t.radius*4;Math.abs(t.pos.x-a.pos.x)<r&&Math.abs(t.pos.y-a.pos.y)<n&&(l=!0)}else if(t.weaponId==="void_trap"){if(Math.hypot(t.pos.x-a.pos.x,t.pos.y-a.pos.y)<t.radius+a.radius){this.frameCount%20===0&&(this.applyDamage(a,t.damage,t.weaponId),a.hp<=0&&this.handleEnemyDeath(a));continue}}else if(Math.hypot(t.pos.x-a.pos.x,t.pos.y-a.pos.y)<t.radius+a.radius){if(t.weaponId==="ricochet_blade"&&t.lastHitId===a.id)continue;l=!0}if(l){if(t.onHitEffect==="EXPLODE"){this.triggerExplosion(t),t.markedForDeletion=!0;break}if(this.spawnImpactParticles(a.pos,t.color),this.applyDamage(a,t.damage,t.weaponId),t.weaponId==="blood_siphon"&&this.player.hp<this.player.maxHp){const n=1*this.player.stats.might;this.player.hp=Math.min(this.player.maxHp,this.player.hp+n),this.addDamageText(this.player.pos,n,!1,"HEAL")}if(this.player.stats.lifesteal>0&&this.player.hp<this.player.maxHp){const n=t.damage*this.player.stats.lifesteal;this.player.hp=Math.min(this.player.maxHp,this.player.hp+n),(n>=1||Math.random()<.1)&&this.addDamageText(this.player.pos,n,!1,"HEAL")}const r=Math.atan2(a.pos.y-t.pos.y,a.pos.x-t.pos.x);if(a.pos.x+=Math.cos(r)*t.knockback,a.pos.y+=Math.sin(r)*t.knockback,t.weaponId==="ricochet_blade")if(t.lastHitId=a.id,t.pierce>0){t.pierce--;let n=null,d=500;for(const h of this.enemies)if(h!==a&&!h.markedForDeletion){const p=Math.hypot(h.pos.x-t.pos.x,h.pos.y-t.pos.y);p<d&&(d=p,n=h)}if(n){const h=n.pos.x-t.pos.x,p=n.pos.y-t.pos.y,y=Math.hypot(h,p),m=Math.hypot(t.velocity.x,t.velocity.y);t.velocity={x:h/y*m,y:p/y*m}}else{const h=Math.random()*Math.PI*2,p=Math.hypot(t.velocity.x,t.velocity.y);t.velocity={x:Math.cos(h)*p,y:Math.sin(h)*p}}}else t.markedForDeletion=!0;else t.pierce<100&&(t.pierce--,t.pierce<=0&&(t.markedForDeletion=!0));a.hp<=0&&!a.markedForDeletion&&this.handleEnemyDeath(a)}}}),this.frameCount%10===0){const t=this.enemyGrid.getNearby(this.player.pos);for(const i of t){const s=i;if(Math.hypot(s.pos.x-this.player.pos.x,s.pos.y-this.player.pos.y)<s.radius+this.player.radius&&(this.player.hp-=s.damage,this.addDamageText(this.player.pos,s.damage,!1,"PLAYER_DAMAGE"),this.player.hp<=0)){this.isGameOver=!0,this.onGameOver({kills:this.score,time:Math.floor(this.frameCount/60),level:this.player.level,bossKilled:this.bossKilled,gemsCollected:this.gemsCollected,goldCollected:this.goldCollected});break}}}}applyDamage(t,i,s){const a=Math.random()<this.player.stats.luck;let l=a?i*2:i;l=Math.max(1,Math.floor(l)),a&&this.spawnCritParticles(t.pos),t.hp-=l;const r=this.damageTexts.find(n=>n.id===t.lastDamageTextId&&!n.markedForDeletion);if(r&&r.life>.4)r.value+=l,r.text=Math.floor(r.value).toString(),r.life=.8,r.pos.y=t.pos.y-t.radius-15,r.pos.x=t.pos.x+(Math.random()*10-5),a&&(r.isCrit=!0);else{const n=this.addDamageText(t.pos,l,a,"DAMAGE");n&&(t.lastDamageTextId=n.id)}}spawnPickup(t){const i=Math.random();let s=P.GOLD,a=10,l=b.gold;i<.1?(s=P.CHICKEN,a=30,l="#e11d48"):i<.15?(s=P.VACUUM,a=0,l="#06b6d4"):i<.16?(s=P.ROSARY,a=0,l="#f8fafc"):(s=P.GOLD,a=10,l=b.gold),this.pickups.push({id:Math.random().toString(),type:x.PICKUP,pickupType:s,pos:{...t},radius:10,value:a,color:l,markedForDeletion:!1})}addDamageText(t,i,s,a="DAMAGE"){if(i<.5&&a!=="HEAL"||i<=0)return null;let l="#fff";a==="PLAYER_DAMAGE"&&(l="#ef4444"),a==="HEAL"&&(l="#22c55e");const r={id:Math.random().toString(),type:x.TEXT_PARTICLE,pos:{x:t.x,y:t.y-10},text:Math.round(i).toString(),value:i,velocity:{x:Math.random()-.5,y:-1},life:.8,opacity:1,radius:0,color:l,markedForDeletion:!1,isCrit:s};return this.damageTexts.push(r),r}checkLevelUp(){this.player.xp>=this.player.nextLevelXp&&(this.player.level++,this.player.xp-=this.player.nextLevelXp,this.player.nextLevelXp=Math.floor(this.player.nextLevelXp*1.3),this.isPaused=!0,this.onLevelUp(this.generateUpgrades()))}generateUpgrades(){const t=[],i=[],s=I(),a=this.player.weapons.find(h=>h.id==="shadow_bolt");a&&a.level>=a.maxLevel&&i.push({id:"evolve_shadow_bolt",name:"Umbral Barrage",description:"EVOLUTION: Unleash the true power of the void. Replaces Shadow Bolt.",rarity:"legendary",type:"WEAPON",apply:h=>{h.weapons=h.weapons.filter(p=>p.id!=="shadow_bolt"),h.weapons.push(this.getWeaponConfig("umbral_barrage"))}});const l=h=>{const p=M[h],y=this.player.weapons.find(m=>m.id===h);if(y){if(y.level>=y.maxLevel)return;t.push({id:`upgrade_${h}`,name:`${p.name} ${y.level+1}`,description:`Level ${y.level+1}: Increases power/amount.`,rarity:"common",type:"WEAPON",apply:m=>{const e=m.weapons.find(c=>c.id===h);e.level++,e.level%2===0&&(e.damage*=1.2),e.level%3===0&&(e.amount+=1),e.area*=1.1}})}else{if(this.player.weapons.length>=6||!p.unlockCondition(s))return;t.push({id:`new_${h}`,name:p.name,description:p.description,rarity:"rare",type:"WEAPON",apply:m=>{m.weapons.push(this.getWeaponConfig(h))}})}};Object.keys(M).forEach(h=>l(h)),Object.entries(D).forEach(([h,p])=>{const y=this.player.passives.find(m=>m.id===h);if(y){if(y.level>=y.maxLevel)return;t.push({id:`upgrade_${h}`,name:`${p.name} ${y.level+1}`,description:`${p.description} (Lvl ${y.level+1})`,rarity:"common",type:"PASSIVE",apply:m=>{const e=m.passives.find(c=>c.id===h);e.level++,m.stats[p.stat]+=p.increase}})}else{if(this.player.passives.length>=6)return;t.push({id:`new_${h}`,name:p.name,description:p.description,rarity:"common",type:"PASSIVE",apply:m=>{m.passives.push({id:h,name:p.name,description:p.description,level:1,maxLevel:p.maxLevel,icon:p.icon}),m.stats[p.stat]+=p.increase}})}}),t.length===0&&i.length===0&&t.push({id:"heal_fallback",name:"Crimson Vial",description:"Heal 30 HP.",rarity:"common",type:"PASSIVE",apply:h=>{h.hp=Math.min(h.maxHp,h.hp+30)}});const r=t.sort(()=>.5-Math.random()),n=[...i],d=3-n.length;return d>0&&n.push(...r.slice(0,d)),n}cleanup(){this.enemies=this.enemies.filter(t=>!t.markedForDeletion),this.projectiles=this.projectiles.filter(t=>!t.markedForDeletion),this.gems=this.gems.filter(t=>!t.markedForDeletion),this.chests=this.chests.filter(t=>!t.markedForDeletion),this.damageTexts=this.damageTexts.filter(t=>!t.markedForDeletion),this.particles=this.particles.filter(t=>!t.markedForDeletion),this.destructibles=this.destructibles.filter(t=>!t.markedForDeletion),this.pickups=this.pickups.filter(t=>!t.markedForDeletion)}drawPlayer(){const t=this.ctx,i=this.player,s=this.frameCount;t.save(),t.translate(i.pos.x,i.pos.y),t.fillStyle="rgba(0,0,0,0.4)",t.beginPath(),t.ellipse(0,i.radius+4,i.radius,i.radius*.3,0,0,Math.PI*2),t.fill();const a=i.facingRight?1:-1;t.scale(a,1);const l=["kael","vex","seraphina","isolde"].includes(i.characterId),r=l?Math.sin(s*.05)*3:0,n=l?0:Math.sin(s*.1)*.03;if(t.translate(0,r),l||t.scale(1,1-n),i.characterId==="grom")t.fillStyle="#334155",t.fillRect(-10,-12,20,24),t.fillStyle="#475569",t.beginPath(),t.arc(0,-12,11,Math.PI,0),t.lineTo(11,-8),t.lineTo(-11,-8),t.fill(),t.fillStyle="#0ea5e9",t.shadowColor="#0ea5e9",t.shadowBlur=5,t.fillRect(2,-14,8,3),t.shadowBlur=0,t.fillStyle="#1e293b",t.beginPath(),t.moveTo(-10,-10),t.lineTo(-16,-14),t.lineTo(-10,-4),t.fill(),t.beginPath(),t.moveTo(10,-10),t.lineTo(16,-14),t.lineTo(10,-4),t.fill();else if(i.characterId==="lyra"){t.fillStyle="#ea580c",t.beginPath(),t.moveTo(-8,-10),t.lineTo(8,-10),t.lineTo(12,12),t.lineTo(-12,12),t.fill(),t.fillStyle="#fdba74",t.beginPath(),t.arc(0,-12,9,0,Math.PI*2),t.fill(),t.fillStyle="#f97316";const d=Math.sin(s*.2)*2;t.beginPath(),t.moveTo(-9,-14),t.quadraticCurveTo(0,-25+d,9,-14),t.lineTo(9,-10),t.lineTo(-9,-10),t.fill(),t.fillStyle="#fff",t.beginPath(),t.arc(4,-11,2,0,Math.PI*2),t.fill()}else if(i.characterId==="kael"){t.fillStyle="#1e3a8a",t.beginPath(),t.moveTo(0,-15),t.lineTo(10,10),t.lineTo(-10,10),t.fill(),t.fillStyle="#172554",t.beginPath(),t.arc(0,-12,10,0,Math.PI*2),t.fill(),t.fillStyle="#60a5fa",t.shadowColor="#60a5fa",t.shadowBlur=10,t.beginPath(),t.arc(3,-11,2,0,Math.PI*2),t.fill(),t.shadowBlur=0,t.strokeStyle="#93c5fd",t.lineWidth=1;const d=s*.05;t.save(),t.translate(0,-25),t.rotate(d),t.strokeRect(-4,-4,8,8),t.restore()}else if(i.characterId==="vex")t.fillStyle="#581c87",t.beginPath(),t.arc(0,0,12+Math.sin(s*.2),0,Math.PI*2),t.fill(),t.fillStyle="#a855f7",t.shadowColor="#a855f7",t.shadowBlur=15,t.beginPath(),t.arc(0,0,6,0,Math.PI*2),t.fill(),t.shadowBlur=0,t.fillStyle="#fff",t.fillRect(2,-4,4,2),t.fillRect(6,-2,2,2);else if(i.characterId==="seraphina"){t.fillStyle="#db2777",t.beginPath(),t.ellipse(0,0,8,14,0,0,Math.PI*2),t.fill(),t.fillStyle="#fce7f3",t.beginPath(),t.arc(0,-14,8,0,Math.PI*2),t.fill(),t.strokeStyle="#f472b6",t.lineWidth=4,t.lineCap="round",t.beginPath(),t.moveTo(-4,-10);const d=Math.sin(s*.2)*5;t.quadraticCurveTo(-15,-10,-25,-5+d),t.stroke(),t.fillStyle="#000",t.beginPath(),t.arc(4,-14,1.5,0,Math.PI*2),t.fill()}else i.characterId==="darius"?(t.fillStyle="#7f1d1d",t.fillRect(-9,-10,18,20),t.fillStyle="#000",t.beginPath(),t.moveTo(-9,-10),t.lineTo(-14,-18),t.lineTo(-5,-10),t.fill(),t.beginPath(),t.moveTo(9,-10),t.lineTo(14,-18),t.lineTo(5,-10),t.fill(),t.fillStyle="#991b1b",t.beginPath(),t.arc(0,-12,9,0,Math.PI*2),t.fill(),t.fillStyle="#fca5a5",t.shadowColor="#ef4444",t.shadowBlur=5,t.beginPath(),t.arc(3,-11,2,0,Math.PI*2),t.fill(),t.shadowBlur=0):i.characterId==="isolde"?(t.fillStyle="#0891b2",t.beginPath(),t.moveTo(0,-12),t.lineTo(10,12),t.lineTo(-10,12),t.fill(),t.fillStyle="#cffafe",t.beginPath(),t.arc(0,-12,8,0,Math.PI*2),t.fill(),t.fillStyle="#a5f3fc",t.beginPath(),t.moveTo(-8,-14),t.lineTo(-5,-20),t.lineTo(0,-16),t.lineTo(5,-20),t.lineTo(8,-14),t.fill(),t.fillStyle="#164e63",t.beginPath(),t.arc(3,-11,1.5,0,Math.PI*2),t.fill()):i.characterId==="grimwald"?(t.fillStyle="#78350f",t.fillRect(-10,-10,20,20),t.fillStyle="#451a03",t.beginPath(),t.arc(0,-12,10,0,Math.PI*2),t.fill(),t.fillStyle="#000",t.beginPath(),t.arc(0,-10,6,0,Math.PI,!1),t.fill()):i.characterId==="ignis"?(t.fillStyle="#b91c1c",t.beginPath(),t.rect(-9,-10,18,20),t.fill(),t.fillStyle="#fecaca",t.beginPath(),t.arc(0,-12,9,0,Math.PI*2),t.fill(),t.fillStyle="#333",t.beginPath(),t.arc(2,-13,4,0,Math.PI*2),t.arc(7,-13,4,0,Math.PI*2),t.fill(),t.fillStyle="#4ade80",t.shadowColor="#4ade80",t.shadowBlur=5,t.beginPath(),t.arc(2,-13,2,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(7,-13,2,0,Math.PI*2),t.fill(),t.shadowBlur=0):i.characterId==="elara"?(t.fillStyle="#334155",t.beginPath(),t.ellipse(0,2,8,12,0,0,Math.PI*2),t.fill(),t.fillStyle="#f1f5f9",t.beginPath(),t.arc(0,-10,8,0,Math.PI*2),t.fill(),t.fillStyle="#0f172a",t.beginPath(),t.moveTo(-8,-8),t.quadraticCurveTo(0,-4,8,-8),t.lineTo(8,-2),t.quadraticCurveTo(0,4,-8,-2),t.fill(),t.strokeStyle="#ef4444",t.lineWidth=2,t.beginPath(),t.moveTo(-6,-8),t.lineTo(-12,-4+Math.sin(s*.3)*3),t.stroke(),t.fillStyle="#334155",t.beginPath(),t.arc(3,-12,1.5,0,Math.PI*2),t.fill()):(t.fillStyle=i.color,t.beginPath(),t.arc(0,0,i.radius,0,Math.PI*2),t.fill(),t.fillStyle="#fff",t.beginPath(),t.arc(4,-3,3.5,0,Math.PI*2),t.fill(),t.fillStyle="#000",t.beginPath(),t.arc(5.5,-3,1.5,0,Math.PI*2),t.fill());t.restore()}draw(){const t=window.devicePixelRatio||1;this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore();const i=window.innerWidth/2-this.player.pos.x,s=window.innerHeight/2-this.player.pos.y,a=this.player.pos.x-window.innerWidth/2-100,l=this.player.pos.y-window.innerHeight/2-100,r=window.innerWidth+200,n=window.innerHeight+200,d=(e,c)=>e.x+c>a&&e.x-c<a+r&&e.y+c>l&&e.y-c<l+n;if(this.bgPattern){this.ctx.save(),this.ctx.translate(i,s),this.ctx.fillStyle=this.bgPattern;const e=this.player.pos.x-window.innerWidth/2,c=this.player.pos.y-window.innerHeight/2;this.ctx.fillRect(e-100,c-100,window.innerWidth+200,window.innerHeight+200),this.ctx.restore()}else this.ctx.fillStyle=b.background,this.ctx.fillRect(0,0,window.innerWidth,window.innerHeight);this.ctx.save(),this.ctx.translate(i,s),this.destructibles.forEach(e=>{d(e.pos,e.radius)&&(this.ctx.fillStyle=e.color,this.ctx.beginPath(),this.ctx.fillRect(e.pos.x-4,e.pos.y,8,20),this.ctx.arc(e.pos.x,e.pos.y,8,0,Math.PI,!1),this.ctx.fill(),this.ctx.fillStyle="#f59e0b",this.ctx.fillStyle="rgba(0,0,0,0.3)",this.ctx.beginPath(),this.ctx.ellipse(e.pos.x,e.pos.y+18,6,3,0,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle="#f59e0b",this.ctx.beginPath(),this.ctx.arc(e.pos.x,e.pos.y-5,6+Math.sin(this.frameCount*.2)*2,0,Math.PI*2),this.ctx.fill())}),this.pickups.forEach(e=>{d(e.pos,20)&&(this.ctx.fillStyle=e.color,this.ctx.save(),this.ctx.translate(e.pos.x,e.pos.y+Math.sin(this.frameCount*.1)*3),e.pickupType===P.GOLD?(this.ctx.beginPath(),this.ctx.arc(0,0,6,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle="#fff",this.ctx.font="8px Arial",this.ctx.textAlign="center",this.ctx.fillText("$",0,3)):e.pickupType===P.CHICKEN?(this.ctx.fillRect(-6,-4,12,8),this.ctx.fillStyle="#fff",this.ctx.fillRect(4,-4,2,8)):e.pickupType===P.VACUUM?(this.ctx.beginPath(),this.ctx.arc(0,0,8,0,Math.PI*2),this.ctx.strokeStyle="#fff",this.ctx.lineWidth=2,this.ctx.stroke(),this.ctx.fillStyle=e.color,this.ctx.fill()):(this.ctx.beginPath(),this.ctx.arc(0,0,6,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle="#94a3b8",this.ctx.beginPath(),this.ctx.arc(0,-10,2,0,Math.PI*2),this.ctx.stroke()),this.ctx.restore())}),this.gems.forEach(e=>{d(e.pos,10)&&(this.ctx.fillStyle=e.color,this.ctx.beginPath(),this.ctx.moveTo(e.pos.x,e.pos.y-e.radius),this.ctx.lineTo(e.pos.x+e.radius,e.pos.y),this.ctx.lineTo(e.pos.x,e.pos.y+e.radius),this.ctx.lineTo(e.pos.x-e.radius,e.pos.y),this.ctx.fill())}),this.chests.forEach(e=>{if(!d(e.pos,e.radius))return;const c=e.pos.x,v=e.pos.y,S=30,u=20;this.ctx.save(),this.ctx.translate(c,v),this.ctx.fillStyle="#92400e",this.ctx.fillRect(-S/2,-u/2,S,u),this.ctx.fillStyle="#fbbf24",this.ctx.fillRect(-S/2,-u/4,S,u/4),this.ctx.fillRect(-4,-u/2,8,u),this.ctx.fillStyle="#000",this.ctx.fillRect(-2,-2,4,4),this.ctx.restore()});const h=this.player.weapons.find(e=>e.id==="corrosive_aura");if(h){const e=h.area*50*this.player.stats.area,c=this.ctx.createRadialGradient(this.player.pos.x,this.player.pos.y,e*.2,this.player.pos.x,this.player.pos.y,e);c.addColorStop(0,"rgba(132, 204, 22, 0)"),c.addColorStop(.8,"rgba(132, 204, 22, 0.2)"),c.addColorStop(1,"rgba(132, 204, 22, 0)"),this.ctx.fillStyle=c,this.ctx.beginPath(),this.ctx.arc(this.player.pos.x,this.player.pos.y,e,0,Math.PI*2),this.ctx.fill()}this.enemies.forEach(e=>{if(d(e.pos,e.radius)){if(this.ctx.save(),this.ctx.translate(e.pos.x,e.pos.y),this.player.pos.x<e.pos.x&&this.ctx.scale(-1,1),this.ctx.globalAlpha=e.opacity||1,this.ctx.shadowBlur=0,e.enemyType===g.BOSS){this.ctx.shadowBlur=20,this.ctx.shadowColor=e.color;const c=Math.sin(this.frameCount*.1)*3;this.ctx.fillStyle="#2e1065",this.ctx.beginPath(),this.ctx.arc(0,0,e.radius+c,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle="#a855f7",this.ctx.lineWidth=3,this.ctx.beginPath();const v=10;for(let S=0;S<=v;S++){const u=Math.PI*2*S/v+this.frameCount*.02,T=e.radius*.8,C=e.radius*1.2,E=Math.cos(u),R=Math.sin(u);S===0&&this.ctx.moveTo(E*T,R*T),this.ctx.lineTo(E*C,R*C),this.ctx.lineTo(Math.cos(u+.1)*T,Math.sin(u+.1)*T)}this.ctx.stroke(),this.ctx.fillStyle="#000",this.ctx.beginPath(),this.ctx.arc(0,0,e.radius*.6,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle="#ef4444",this.ctx.shadowColor="#ef4444",this.ctx.shadowBlur=10,this.ctx.beginPath(),this.ctx.moveTo(-10,-5),this.ctx.lineTo(-5,0),this.ctx.lineTo(-12,2),this.ctx.fill(),this.ctx.beginPath(),this.ctx.moveTo(10,-5),this.ctx.lineTo(5,0),this.ctx.lineTo(12,2),this.ctx.fill(),this.ctx.shadowBlur=0,this.ctx.save(),this.player.pos.x<e.pos.x&&this.ctx.scale(-1,1),this.ctx.fillStyle="black",this.ctx.fillRect(-30,-e.radius-20,60,6),this.ctx.fillStyle="#dc2626",this.ctx.fillRect(-29,-e.radius-19,58*(e.hp/e.maxHp),4),this.ctx.restore()}else this.ctx.save(),this.ctx.globalAlpha=.3,this.ctx.fillStyle="#000",this.ctx.beginPath(),this.ctx.ellipse(0,e.radius/2,e.radius,e.radius*.4,0,0,Math.PI*2),this.ctx.fill(),this.ctx.restore();if(e.enemyType===g.BAT){const c=Math.sin(this.frameCount*.4+e.animationOffset)*10;this.ctx.fillStyle="#1e293b",this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.quadraticCurveTo(10,-10+c,15,-5+c/2),this.ctx.quadraticCurveTo(8,5,0,2),this.ctx.moveTo(0,0),this.ctx.quadraticCurveTo(-10,-10+c,-15,-5+c/2),this.ctx.quadraticCurveTo(-8,5,0,2),this.ctx.fill(),this.ctx.beginPath(),this.ctx.arc(0,0,e.radius*.6,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle="#ef4444",this.ctx.beginPath(),this.ctx.arc(2,-2,1.5,0,Math.PI*2),this.ctx.arc(5,-2,1.5,0,Math.PI*2),this.ctx.fill()}else if(e.enemyType===g.ZOMBIE){const c=Math.sin(this.frameCount*.15+e.animationOffset)*.1;this.ctx.rotate(c),this.ctx.fillStyle=e.visualVariant===1?"#365314":"#15803d",this.ctx.beginPath(),this.ctx.roundRect(-8,-6,16,14,4),this.ctx.fill(),this.ctx.fillStyle="#86efac",this.ctx.beginPath(),this.ctx.arc(0,-8,7,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle="#86efac",this.ctx.beginPath(),this.ctx.roundRect(4,-4,10,3,1.5),this.ctx.roundRect(4,1,10,3,1.5),this.ctx.fill(),this.ctx.fillStyle="#14532d",this.ctx.beginPath(),this.ctx.arc(2,-9,2,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle="#fca5a5",e.visualVariant===2&&(this.ctx.beginPath(),this.ctx.arc(-3,-11,2.5,0,Math.PI*2),this.ctx.fill())}else if(e.enemyType===g.SKELETON){const c=Math.abs(Math.sin(this.frameCount*.15+e.animationOffset))*2;this.ctx.translate(0,-c),this.ctx.strokeStyle="#e2e8f0",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(0,-4),this.ctx.lineTo(0,8),this.ctx.moveTo(-5,-2),this.ctx.lineTo(5,-2),this.ctx.moveTo(-4,2),this.ctx.lineTo(4,2),this.ctx.moveTo(-3,6),this.ctx.lineTo(3,6),this.ctx.stroke(),this.ctx.fillStyle="#f1f5f9",this.ctx.beginPath(),this.ctx.arc(0,-8,6.5,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle="#e2e8f0",this.ctx.fillRect(-3,-4,6,4),this.ctx.fillStyle="#0f172a",this.ctx.beginPath(),this.ctx.arc(2,-9,1.5,0,Math.PI*2),this.ctx.arc(-1,-9,1.5,0,Math.PI*2),this.ctx.fill(),this.ctx.save(),this.ctx.translate(8,2),this.ctx.rotate(-.5),this.ctx.fillStyle="#713f12",this.ctx.fillRect(0,-4,2,8),this.ctx.fillStyle="#94a3b8",this.ctx.beginPath(),this.ctx.moveTo(0,-4),this.ctx.quadraticCurveTo(8,-10,2,-14),this.ctx.lineTo(0,-4),this.ctx.fill(),this.ctx.restore()}else if(e.enemyType===g.GHOST){const c=Math.sin(this.frameCount*.05+e.animationOffset)*3;this.ctx.translate(0,c),this.ctx.shadowBlur=0,this.ctx.fillStyle="rgba(207, 250, 254, 0.8)",this.ctx.beginPath(),this.ctx.arc(0,-6,8,Math.PI,0);const v=this.frameCount*.15+e.animationOffset;this.ctx.lineTo(8,8),this.ctx.quadraticCurveTo(4,4+Math.sin(v)*3,0,10),this.ctx.quadraticCurveTo(-4,4+Math.cos(v)*3,-8,8),this.ctx.lineTo(-8,-6),this.ctx.fill(),this.ctx.fillStyle="#06b6d4",this.ctx.beginPath(),this.ctx.arc(3,-6,2,0,Math.PI*2),this.ctx.arc(-1,-6,2,0,Math.PI*2),this.ctx.fill(),this.ctx.beginPath(),this.ctx.arc(1,-2,1.5,0,Math.PI*2),this.ctx.fill()}else e.enemyType!==g.BOSS&&(this.ctx.fillStyle=e.color,this.ctx.beginPath(),this.ctx.arc(0,0,e.radius,0,Math.PI*2),this.ctx.fill());this.ctx.restore()}}),this.drawPlayer(),this.projectiles.forEach(e=>{if(d(e.pos,e.radius*2)){if(this.ctx.save(),this.ctx.translate(e.pos.x,e.pos.y),isNaN(e.pos.x)||isNaN(e.pos.y)){this.ctx.restore();return}switch(e.weaponId){case"shadow_bolt":{const c=Math.atan2(e.velocity.y,e.velocity.x);this.ctx.rotate(c),this.ctx.fillStyle="rgba(129, 140, 248, 0.3)",this.ctx.beginPath(),this.ctx.ellipse(0,0,e.radius*2,e.radius*1.2,0,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle="#fff",this.ctx.beginPath(),this.ctx.ellipse(0,0,e.radius*1.5,e.radius*.8,0,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle=e.color,this.ctx.globalAlpha=.6,this.ctx.beginPath(),this.ctx.ellipse(-e.radius,0,e.radius*2,e.radius,0,0,Math.PI*2),this.ctx.fill();break}case"umbral_barrage":{const c=Math.atan2(e.velocity.y,e.velocity.x);this.ctx.rotate(c),this.ctx.shadowBlur=10,this.ctx.shadowColor="#a855f7",this.ctx.fillStyle="#000",this.ctx.beginPath(),this.ctx.arc(0,0,e.radius*.6,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle=e.color,this.ctx.globalAlpha=.8;for(let v=0;v<3;v++){const S=this.frameCount*.5+v*2;this.ctx.beginPath(),this.ctx.ellipse(-e.radius,Math.sin(S)*4,e.radius*2.5,e.radius*.5,0,0,Math.PI*2),this.ctx.fill()}break}case"obsidian_shard":{this.ctx.rotate(this.frameCount*.1),this.ctx.fillStyle="#334155",this.ctx.beginPath(),this.ctx.moveTo(-e.radius,-e.radius*.5),this.ctx.lineTo(0,-e.radius),this.ctx.lineTo(e.radius,-e.radius*.5),this.ctx.lineTo(e.radius*.5,e.radius),this.ctx.lineTo(-e.radius*.8,e.radius*.8),this.ctx.fill();break}case"spectral_shield":{this.ctx.rotate(this.frameCount*.1),this.ctx.globalCompositeOperation="lighter",this.ctx.fillStyle="#a5f3fc",this.ctx.shadowColor="#0891b2",this.ctx.shadowBlur=10,this.ctx.beginPath(),this.ctx.moveTo(0,-e.radius),this.ctx.lineTo(e.radius*.6,0),this.ctx.lineTo(0,e.radius),this.ctx.lineTo(-e.radius*.6,0),this.ctx.fill();break}case"whirling_axe":{this.ctx.rotate(this.frameCount*.3),this.ctx.fillStyle="#94a3b8",this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.arc(0,0,e.radius,0,Math.PI/2),this.ctx.lineTo(0,0),this.ctx.arc(0,0,e.radius,Math.PI,Math.PI*1.5),this.ctx.fill(),this.ctx.fillStyle="#451a03",this.ctx.fillRect(-2,-e.radius,4,e.radius*2);break}case"plasma_cutter":{const c=Math.atan2(e.velocity.y,e.velocity.x);this.ctx.rotate(c),this.ctx.globalCompositeOperation="lighter",this.ctx.fillStyle=e.color,this.ctx.shadowColor=e.color,this.ctx.shadowBlur=15,this.ctx.fillRect(-e.radius,-e.radius/2,e.radius*4,e.radius),this.ctx.fillStyle="#fff",this.ctx.fillRect(-e.radius,-e.radius/4,e.radius*3,e.radius/2);break}case"flame_breath":case"inferno_grenade":{this.ctx.globalCompositeOperation="lighter",this.ctx.fillStyle="#ef4444",this.ctx.shadowColor="#f97316",this.ctx.shadowBlur=10,this.ctx.beginPath(),this.ctx.arc(0,0,e.radius,0,Math.PI*2),this.ctx.fill();break}case"phantom_daggers":case"ricochet_blade":{const c=Math.atan2(e.velocity.y,e.velocity.x);this.ctx.rotate(c),this.ctx.fillStyle="#e2e8f0",this.ctx.shadowBlur=0,this.ctx.beginPath(),this.ctx.moveTo(e.radius,0),this.ctx.lineTo(-e.radius,e.radius/3),this.ctx.lineTo(-e.radius,-e.radius/3),this.ctx.fill();break}case"blood_siphon":{const c=Math.atan2(e.velocity.y,e.velocity.x)-Math.PI/2;this.ctx.rotate(c),this.ctx.fillStyle="#dc2626",this.ctx.beginPath(),this.ctx.moveTo(0,-e.radius),this.ctx.bezierCurveTo(e.radius,-e.radius/3,e.radius,e.radius,0,e.radius),this.ctx.bezierCurveTo(-e.radius,e.radius,-e.radius,-e.radius/3,0,-e.radius),this.ctx.fill(),this.ctx.fillStyle="#fff",this.ctx.globalAlpha=.6,this.ctx.beginPath(),this.ctx.ellipse(e.radius/3,-e.radius/3,e.radius/4,e.radius/6,Math.PI/4,0,Math.PI*2),this.ctx.fill();break}case"frost_nova":{this.ctx.strokeStyle="#a5f3fc",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(0,0,e.radius,0,Math.PI*2),this.ctx.stroke();break}case"vortex_orb":{this.ctx.rotate(this.frameCount*-.2),this.ctx.fillStyle="#4c1d95",this.ctx.beginPath(),this.ctx.arc(0,0,e.radius,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle="#8b5cf6",this.ctx.lineWidth=2;for(let c=0;c<4;c++)this.ctx.rotate(Math.PI/2),this.ctx.beginPath(),this.ctx.arc(e.radius,0,e.radius/2,0,Math.PI*2),this.ctx.stroke();break}case"void_trap":{this.ctx.shadowColor="#581c87",this.ctx.shadowBlur=10,this.ctx.strokeStyle="#a855f7",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(0,0,e.radius,0,Math.PI*2),this.ctx.stroke(),this.ctx.fillStyle="rgba(88, 28, 135, 0.3)",this.ctx.fill(),this.ctx.save(),this.ctx.rotate(this.frameCount*.05),this.ctx.beginPath(),this.ctx.moveTo(0,-e.radius+5),this.ctx.lineTo(e.radius-5,e.radius/2),this.ctx.lineTo(-e.radius+5,e.radius/2),this.ctx.closePath(),this.ctx.stroke(),this.ctx.restore();break}default:this.ctx.fillStyle=e.color,this.ctx.beginPath(),this.ctx.arc(0,0,e.radius,0,Math.PI*2),this.ctx.fill()}this.ctx.restore()}}),this.particles.forEach(e=>{if(!d(e.pos,e.radius))return;this.ctx.save();const c=e.life/e.maxLife;this.ctx.globalCompositeOperation="lighter",e.renderType==="LIGHTNING"&&e.targetPos?(this.ctx.beginPath(),this.ctx.strokeStyle=e.color,this.ctx.lineWidth=e.width||2,this.ctx.globalAlpha=c,this.ctx.moveTo(e.pos.x,e.pos.y),this.ctx.lineTo(e.targetPos.x,e.targetPos.y),this.ctx.stroke()):e.renderType==="EXPLOSION"?(this.ctx.shadowColor=e.color,this.ctx.shadowBlur=20,this.ctx.fillStyle=e.color,this.ctx.globalAlpha=c*.8,this.ctx.beginPath(),this.ctx.arc(e.pos.x,e.pos.y,e.radius,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle="#fff",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(e.pos.x,e.pos.y,e.radius*(2-c),0,Math.PI*2),this.ctx.stroke()):e.renderType==="FROST_NOVA"?(this.ctx.shadowColor="#22d3ee",this.ctx.shadowBlur=15,this.ctx.strokeStyle="#67e8f9",this.ctx.lineWidth=4,this.ctx.globalAlpha=c,this.ctx.beginPath(),this.ctx.arc(e.pos.x,e.pos.y,e.radius*(1.5-c*.5),0,Math.PI*2),this.ctx.stroke()):e.renderType==="SPARK"?(this.ctx.fillStyle=e.color,this.ctx.globalAlpha=c,this.ctx.beginPath(),this.ctx.arc(e.pos.x,e.pos.y,e.radius*c,0,Math.PI*2),this.ctx.fill()):e.renderType==="BLOOD"?(this.ctx.globalCompositeOperation="source-over",this.ctx.fillStyle=e.color,this.ctx.globalAlpha=c*.8,this.ctx.beginPath(),this.ctx.arc(e.pos.x,e.pos.y,e.radius*c,0,Math.PI*2),this.ctx.fill()):e.renderType==="CRIT"&&(this.ctx.translate(e.pos.x,e.pos.y),this.ctx.rotate(this.frameCount*.2),this.ctx.fillStyle=e.color,this.ctx.shadowColor=e.color,this.ctx.shadowBlur=10,this.ctx.globalAlpha=c,this.ctx.fillRect(-e.radius/2,-e.radius/2,e.radius,e.radius)),this.ctx.restore()}),this.damageTexts.forEach(e=>{if(!d(e.pos,50))return;this.ctx.save(),this.ctx.globalAlpha=e.opacity;const c=e.life>.6?1.5:1;e.isCrit?(this.ctx.font="bold 32px Inter",this.ctx.fillStyle="#fbbf24",this.ctx.shadowColor="#d97706",this.ctx.shadowBlur=10):(this.ctx.font="bold 16px Inter",this.ctx.fillStyle=e.color,this.ctx.shadowBlur=0);const v=1+e.value/1e3,S=Math.min(2.5,v*c);this.ctx.translate(e.pos.x,e.pos.y),this.ctx.scale(S,S),this.ctx.fillText(e.text,0,0),e.isCrit&&e.life>.7&&(this.ctx.globalCompositeOperation="overlay",this.ctx.fillStyle="#fff",this.ctx.fillText(e.text,0,0)),this.ctx.restore()}),this.ctx.restore();const p=this.canvas.width/t,y=this.canvas.height/t,m=this.ctx.createRadialGradient(p/2,y/2,y/2,p/2,y/2,y);m.addColorStop(0,"rgba(0,0,0,0)"),m.addColorStop(1,"rgba(0,0,0,0.6)"),this.ctx.fillStyle=m,this.ctx.fillRect(0,0,p,y)}}const W=Object.freeze(Object.defineProperty({__proto__:null,GameEngine:H},Symbol.toStringTag,{value:"Module"}));export{G as A,A as C,W as E,D as P,M as W,b as a,B as b,I as l,U as p,N as s};
